<ul class="c-tree">
    <!-- Lines -->

    <ul class="c-tree">
        <ul class="c-tree">
            <% @lines.each_pair do |name, v| %>
                    <label class="c-toggle" >
                        <input type="checkbox" onchange='toggleLine(<%=name.to_json%>);' <%= v[:show] ? 'checked' : '' %>>
                        <%
                            style = "background-color:#{@lines_style[name]['color']};"
                            if font_color = @lines_style[name]['lineLabelFontColor']
                                style << "color:#{font_color};"
                            end
                        %>
                        <div class="c-toggle__track" style="<%=style%>" >
                            <div class="c-toggle__handle"></div>
                        </div>
                        <%= name %>
                    </label>
            <% end %>
        </ul>
    </ul>

    <!-- Plans -->

    <ul class="c-tree">
    <% @plans.each_pair do |name, plan| %>
        <li class="c-tree__item c-tree__item--expandable">
            <span class="c-link"><%= "#{name} #{plan[:year]}" %></span>
            <a class="c-link" href="<%= plan[:url] %>" target="_blank" + title="Link a la ley">
                <span class="plan-link fa fa-external-link"></span>
            </a>
            <ul class="c-tree" style="display: none;">
                <% plan[:lines].each do |line| %>
                        <label class="c-toggle">
                            <input type="checkbox"
                                onchange='togglePlanLine(<%= name.to_json %>, <%= line[:name].to_json %>, <%= line[:id].to_json %>)'
                                <%= line[:show] ? 'checked' : '' %>/>
                            <%
                                style = "background-color:#{@lines_style[line[:name]]['color']};"
                                if font_color = @lines_style[line[:name]]['lineLabelFontColor']
                                    style << "color:#{font_color};"
                                end
                            %>

                            <div class="c-toggle__track" style="<%=style%>" >
                                <div class="c-toggle__handle"></div>
                            </div>
                            <%= line[:name] %>
                        </label>
                <% end %>
            </ul>
        </li>
    <% end %>
    <ul class="c-tree">
</ul>

<script>
function toggleLine(line) {
   var lines_params = app.timeline.toggleLine(line);
   var year_start = (app.timeline.lines[line].show) ? app.years.start : app.timeline.current_year();
   var year_end = (app.timeline.lines[line].show) ? app.timeline.current_year() : app.years.start;

   app.change_line_to_year(year_start,year_end,line,function(){
    app.set_current_year_info();
   });
  
   save_params(null,null,lines_params);
}

function togglePlanLine(plan, line, planLineId) {
    $.when(app.planification.toggle(plan, line, planLineId)).then(function(plans_params){
        app.set_current_year_info();
        save_params(null,null,null,plans_params);
    });
}

$(".c-tree__item").click(function(){
    var el = $(this);
    if (el.hasClass("c-tree__item--expanded")) {
          el.removeClass("c-tree__item--expanded");
          el.addClass("c-tree__item--expandable");
          el.children(".c-tree").hide(); 
    } else if (el.hasClass("c-tree__item--expandable")) {
          el.removeClass("c-tree__item--expandable");
          el.addClass("c-tree__item--expanded"); 
          el.children(".c-tree").show();
    }
})
</script>
