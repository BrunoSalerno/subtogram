<ul class="c-tree">
    <!-- Lines -->

    <ul class="c-tree">
        <li class="c-tree__item c-tree__item--expanded">
            <span class="c-link">LÃ­neas</span>
            <ul class="c-tree">
                <% @lines.each_pair do |name, v| %>
                        <style>
                            <%= ".c-toggle input#checkbox_#{name}:checked+.c-toggle__track {background-color:#{@lines_style[name]['color']};}"%>
                        </style>
                        <label class="c-toggle" >
                            <input id="checkbox_<%=name%>" type="checkbox" onchange='toggleLine(<%=name.to_json%>);' <%= v[:show] ? 'checked' : '' %>>
                            <div class="c-toggle__track">
                                <div class="c-toggle__handle"></div>
                            </div>
                            <%= name %>
                        </label>
                <% end %>
            </ul>
        </li>
    </ul>

    <!-- Plans -->

    <ul class="c-tree">
    <% @plans.each_pair do |name, plan| %>
        <li class="c-tree__item c-tree__item--expandable">
            <span class="c-link"><%= "#{name} #{plan[:year]}" %></span>
            <a class="c-link c-link--secondary" href="<%= plan[:url] %>" target="_blank" + title="Link a la ley">
                <span class="plan-link fa fa-external-link"></span>
            </a>
            <ul class="c-tree" style="display: none;">
                <% plan[:lines].each do |line| %>
                        <style>
                            <%= ".c-toggle input#checkbox_#{name.gsub(' ','_')}_#{line[:name]}:checked+.c-toggle__track {background-color:#{@lines_style[line[:name]]['color']};}"%>
                        </style>
                        <label class="c-toggle">
                            <input id="checkbox_<%=name.gsub(' ','_')%>_<%=line[:name]%>" type="checkbox"
                                onchange='togglePlanLine(<%= name.to_json %>, <%= line[:name].to_json %>, <%= line[:id].to_json %>)'
                                <%= line[:show] ? 'checked' : '' %>/>
                            <div class="c-toggle__track">
                                <div class="c-toggle__handle"></div>
                            </div>
                            <%= line[:name] %>
                        </label>
                <% end %>
            </ul>
        </li>
    <% end %>
    <ul class="c-tree">
</ul>

<script>
function toggleLine(line) {
   var lines_params = app.timeline.toggleLine(line);
   var year_start = (app.timeline.lines[line].show) ? app.years.start : app.timeline.current_year();
   var year_end = (app.timeline.lines[line].show) ? app.timeline.current_year() : app.years.start;

   app.change_line_to_year(year_start,year_end,line,function(){
    app.set_current_year_info();
   });
  
   save_params(null,null,lines_params);
}

function togglePlanLine(plan, line, planLineId) {
    $.when(app.planification.toggle(plan, line, planLineId)).then(function(plans_params){
        app.set_current_year_info();
        save_params(null,null,null,plans_params);
    });
}

$(".c-tree__item").click(function(){
    var el = $(this);
    if (el.hasClass("c-tree__item--expanded")) {
          el.removeClass("c-tree__item--expanded");
          el.addClass("c-tree__item--expandable");
          el.children(".c-tree").hide(); 
    } else if (el.hasClass("c-tree__item--expandable")) {
          el.removeClass("c-tree__item--expandable");
          el.addClass("c-tree__item--expanded"); 
          el.children(".c-tree").show();
    }
})
</script>
